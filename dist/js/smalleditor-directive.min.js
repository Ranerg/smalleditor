/*! smalleditor-0.0.1 05-09-2014 */
var smalleditor=angular.module("smalleditor");smalleditor.service("SmalleditorService",function(){this.isFirefox=navigator.userAgent.match(/firefox/i),this.isChrome=navigator.userAgent.match(/chrome/i),this.setCaret=function(a){if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();if(!b)return;b.selectNodeContents(a),b.collapse(!1),this.isFirefox&&b.setEndBefore($(a).find("br").get(0));var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}},this.getSelectionStart=function(){var a=document.getSelection().anchorNode,b=a&&3===a.nodeType?a.parentNode:a;return b},this.rangeSelectsSingleNode=function(a){var b=a.startContainer;return b===a.endContainer&&b.hasChildNodes()&&a.endOffset===a.startOffset+1},this.getSelectedParentElement=function(){var a=null,b=window.getSelection(),c=b.getRangeAt(0);return a=this.rangeSelectsSingleNode(c)?c.startContainer.childNodes[c.startOffset]:3===c.startContainer.nodeType?c.startContainer.parentNode:c.startContainer}}),smalleditor.directive("smalleditor",["$timeout","SmalleditorCore","SmalleditorService",function(a,b,c){"use strict";return{scope:{api:"=?api"},templateUrl:"views/_se_toolbar.html",link:function(d,e,f){var g=d.api={};d.position={top:10,left:10,below:!1},d.buttons={},(f.buttons||"b,i").split(",").reduce(function(a,b){var c=b.trim().toLowerCase();return c&&(a[c]=!0),a},d.buttons),d.enableToolbar="false"!=f.enabletoolbar,d.showToolbar="true"==f.showtoolbar,d.showPlaceholder=!1,d.placeholder=f.placeholder||"Type your text",d.iconTheme=f.icontheme,d.allowPaste="false"!=f.paste,d.plainPaste="false"!=f.plain_paste,d.htmlPaste="true"==f.html_paste;var h="p h1 h2 h3 h4 h5 h6 pre blockquote".split(" "),i=h.join(","),j="span em strong mark".split(" "),k=j.join(","),l=e.find(".smalleditor-toolbar"),m=e.find(".smalleditor-content"),n=angular.element(document.getElementsByTagName("body"));m.attr("contenteditable",!0);var o=function(){return b.generateRandomName()},p=function(){var a=l[0].offsetHeight,b=l[0].offsetWidth,c=5,e=window.getSelection(),f=e.getRangeAt(0),g=f.getBoundingClientRect(),h=g.top,i=g.left;g.top<a+c?(d.position.top=h+g.height+c,d.position.below=!0):(d.position.top=h-a-c,d.position.below=!1),d.position.left=i-b/2+g.width/2;var j=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,k=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;return d.position.top+=k,d.position.left+=j,this},q=function(b){if(b&&b.target&&l.find(b.target).length)return!1;var c=window.getSelection(),e=c.anchorNode;if(!e)return d.showToolbar=!1,this;for(var f=e.parentNode;void 0!==f.tagName&&f!==m.get(0);)f=f.parentNode;return f===m.get(0)?(a(function(){""!==c.toString().trim()&&e?(d.showToolbar=!0,p()):d.showToolbar=!1}),s()):a(function(){d.showToolbar=!1}),this},r=function(){m.bind("keyup",q),document.addEventListener("mouseup",q);var a;m.bind("blur",function(){a&&clearTimeout(a),a=setTimeout(q,200)})},s=function(){var a=c.getSelectedParentElement();for(d.styles={};a&&void 0!==a.tagName&&m.get(0)!=a;)d.styles[a.tagName.toLowerCase()]=!0,a=a.parentNode},t=function(){""===m.get(0).textContent.replace(/^\s+|\s+$/g,"")&&(d.showPlaceholder=!0)},u=function(a){d.showPlaceholder=!1,(!a||"keypress"!==a.type&&"paste"!==a.type)&&t()},v=function(){t(),m.on("blur.placeholder",t).on("keypress.placeholder paste.placeholder",u)},w=function(){m.on("paste.se_paste",function(a){if(a.preventDefault(),!d.allowPaste)return!1;var c=a.originalEvent||a;if(c.clipboardData)if(c.clipboardData.getData("text/plain")&&d.plainPaste){for(var e=c.clipboardData.getData("text/plain").split(/[\r\n]/g),f="",g=0;g<e.length;g+=1)if(""!==e[g].trim()){var h=b.htmlEntities(e[g].trim());h&&(f+=0===g?h:'<p name="'+o()+'" class="se-elem se-elem--p">'+h+"</p>")}f&&document.execCommand("insertHTML",!1,f)}else c.clipboardData.getData("text/html")&&d.htmlPaste})},x=function(){m.find("> .se-elem").find(i).contents().unwrap()},y=function(){m.on("keyup.internal_noise, paste.internal_noise, focus.internal_noise",function(){a(function(){m.find("> br[type=_moz], > br").remove(),m.find(k).contents().unwrap(),m.find("[style]").removeAttr("style"),x()})})},z=function(){m.find(".se-elem--first").removeClass("se-elem--first"),m.find(".se-elem").first().addClass("se-elem--first")},A=function(){var a=$("<p>",{name:o(),"class":"se-elem se-elem--p"}).appendTo(m);return a.append("<br/>"),c.setCaret(a.get(0)),z(),a},B=function(){m.on("blur keyup paste focus",function(){var a=m.find(".se-elem");0===a.size()&&A(),m.contents().each(function(){return function(a,b){return"#text"===b.nodeName?(document.execCommand("insertHTML",!1,"<p name="+o()+" class='se-elem se-elem--p'>"+b.data+"<br/></p>"),z(),b.remove()):void 0}}(this))})},C=function(){m.on("keyup.paragraph_creation",function(a){if(13===a.which&&!a.shiftKey){document.execCommand("formatBlock",!1,"p");var b=c.getSelectionStart(),d=$(b).closest(".se-elem");0===d.size()&&(d=$(b)),d.attr("name",o()).addClass("se-elem se-elem--p"),z()}})},D=function(){v(),r(),w(),C(),y(),B()};d.SimpleAction=function(a,b){if(b=b&&b.toLowerCase(),document.execCommand("styleWithCSS",!1,!1),document.execCommand(a,!1,b),"formatBlock"==a){var d=c.getSelectionStart(),e=$(d).closest(b);0===e.size()&&(e=$(d).prev(b)),e.attr("name",o()).addClass("se-elem se-elem--"+b),x(),z()}},n.append(l),D(),g.dataModel=function(a){return a?(m.html(b.generateHTMLFromModel(a)),void u()):b.generateModel(m)},g.getHTML=function(a){return a?b.generateHTMLFromModel(a):null},g.computeDelta=b.computeDelta,g.applyDelta=b.applyDelta}}}]),angular.module("smalleditor").run(["$templateCache",function(a){"use strict";a.put("views/_se_toolbar.html",'<div class="smalleditor">\n  <div class="smalleditor-toolbar" style="top: {{ position.top }}px; left: {{ position.left }}px" ng-class="{ \'smalleditor-toolbar--show\': showToolbar, \'smalleditor-toolbar--bottom\': position.below }">\n    <div class="se-toolbar-inner">\n      <ul class="se-main-toolbar">\n        <li class="se-li" ng-show="buttons.b">\n          <button type="button" ng-click="SimpleAction(\'bold\')" class="se-button se-button--bold" ng-class="{ \'se-button--active\': styles.b }">\n            <span ng-class="{\'glyphicon glyphicon-bold\': iconTheme == \'bootstrap\'}"><span ng-show=\'!iconTheme\'><b>B</b></span></span>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.i">\n          <button type="button" ng-click="SimpleAction(\'italic\')" class="se-button se-button--italic" ng-class="{ \'se-button--active\': styles.i }">\n            <span ng-class="{\'glyphicon glyphicon-italic\': iconTheme == \'bootstrap\'}"><span ng-show=\'!iconTheme\'><b><i>I</i></b></span></span>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.u">\n          <button type="button" ng-click="SimpleAction(\'underline\')" class="se-button se-button--underline" ng-class="{ \'se-button--active\': styles.u }">\n            <b><u>U</u></b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.h1">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.h1 ? \'p\' : \'h1\')" class="se-button se-button--h1" ng-class="{ \'se-button--active\': styles.h1 }">\n            <b>H1</b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.h2">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.h2 ? \'p\' : \'h2\')" class="se-button se-button--h2" ng-class="{ \'se-button--active\': styles.h2 }">\n            <b>H2</b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.blockquote">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.blockquote ? \'p\' : \'blockquote\')" class="se-button se-button--blockquote" ng-class="{ \'se-button--active\': styles.blockquote }">\n            <b>"</b>\n          </button>\n        </li>\n      </ul>\n    </div>\n    <div class="se-down-arrow-clip">\n      <span class="se-down-arrow"></span>\n    </div>\n  </div>\n  <div class="smalleditor-content" ng-class="{\'smalleditor-placeholder\': showPlaceholder}" data-placeholder="{{ placeholder }}">\n  </div>\n</div>\n')}]);