/*! smalleditor-0.0.1 02-09-2014 */
var smalleditor=angular.module("smalleditor",[]);smalleditor.service("SmalleditorCore",function(){var a=this;this.generateRandomName=function(){return Date.now().toString(36)+Math.round(1e16*Math.random()).toString(36)},this.htmlEntities=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(a).replace(/[&<>"'\/]/g,function(a){return b[a]})};var b={p:1,h1:2,h2:3,blockquote:4},c={};for(var d in b)b.hasOwnProperty(d)&&(c[b[d]]=d);var e={b:1,i:2,u:3,s:4,a:5},f={};for(var g in e)e.hasOwnProperty(g)&&(f[e[g]]=g);var h=function(a,b,c){var d=a.contents();d.each(function(a,d){var f=$(d);if(f.context&&3!==f.context.nodeType){var g=f.context.tagName.toLowerCase(),i=e[g];i&&b.push({type:i,start:c,end:c+f.text().length}),h(f,b,c)}c+=f.text().length})},i=function(a,b){if(b=b||[],!a)return a;for(var c={},d={},e=0;e<b.length;e++){var g=b[e];null!==g.start&&null!==g.end&&(c[g.start]=c[g.start]||[],c[g.start].push(g),d[g.end]=d[g.end]||[],d[g.end].push(g))}for(var h="",i=[],j=0;j<=a.length;j++){if(d[j])for(var k=d[j],l=d[j].length;l>0;){for(var m=0,n=i[i.length-1];m<k.length;){if(n===k[m].type){h+="</"+f[k[m].type]+">",i.pop();break}m++}m<k.length&&k.splice(m,1),l--}if(c[j])for(var o=c[j],p=0;p<o.length;p++){var q=o[p];"undefined"!=typeof f[q.type]&&(i.push(q.type),h+="<"+f[q.type]+">")}"undefined"!=typeof a[j]&&(h+=a[j])}if(0!==i.length)throw new Error("Inconsistent tags");return h},j=function(c){var d=c.prop("tagName").toLowerCase(),e=null;if(d&&"undefined"!=typeof b[d]){var f=[];h(c,f,0),e={markups:f,name:c.attr("name"),text:a.htmlEntities(c.text()),type:b[d]}}return e};this.generateModel=function(a){var b={paragraphs:[]},c=b.paragraphs;return a.find(".se-elem").each(function(){var a=j($(this));a&&c.push(a)}),b},this.generateHTMLFromModel=function(a){if(!a||!a.paragraphs)return null;for(var b=[],d=0;d<a.paragraphs.length;d++){var e=a.paragraphs[d],f=c[e.type];f&&(b.push("<"+f+" name='"+e.name+"' class='se-elem se-elem--"+f+"'>"),b.push(i(e.text,e.markups)),b.push("</"+f+">"))}return b.join("")};var k={CREATE:1,DELETE:2,UPDATE:3},l={};for(var m in k)k.hasOwnProperty(m)&&(l[k[m]]=m);this.computeDelta=function(b,c){var d=[];if(b!=c){var e=b.paragraphs,f=c.paragraphs,g=e.reduce(function(a,b,c){return a[b.name]={value:b,index:c},a},{}),h=f.reduce(function(a,b,c){return a[b.name]={value:b,index:c},a},{});for(var i in g){var j=g[i].value,l=g[i].index;h[i]?angular.equals(j,h[i].value)||d.push({index:h[i].index,paragraph:h[i].value,type:k.UPDATE}):d.push({index:l,type:k.DELETE})}for(var m in h){var n=h[m].value,o=h[m].index;g[m]||d.push({index:o,paragraph:n,type:k.CREATE})}}return{rev:a.generateRandomName(),dt:Date.now(),deltas:d}},this.applyDelta=function(a,b){if(!a||!a.paragraphs)throw new Error("Invalid source object");if(!(b&&b.deltas&&b.dt))throw new Error("Invalid delta object");if(!b.deltas.length)return a;for(var c=0;c<b.deltas.length;c++){var d=b.deltas[c],e=d.paragraph,f=a.paragraphs,g=d.index,h=d.type;if(h!==k.CREATE&&"undefined"==typeof f[g]||h===k.CREATE&&typeof f.length<g-1)throw new Error("Delta is not valid for this source");h===k.DELETE?f.splice(g,1):h===k.CREATE?f.splice(g,0,e):h===k.UPDATE&&(f[g]=e)}return a}});