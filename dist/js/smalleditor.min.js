/*! smalleditor-0.0.1 02-09-2014 */
var smalleditor=angular.module("smalleditor",[]);smalleditor.service("SmalleditorCore",function(){var a=this;this.generateRandomName=function(){return Date.now().toString(36)+Math.round(1e16*Math.random()).toString(36)},this.htmlEntities=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(a).replace(/[&<>"'\/]/g,function(a){return b[a]})};var b={p:1,h1:2,h2:3,blockquote:4},c={};for(var d in b)b.hasOwnProperty(d)&&(c[b[d]]=d);var e={b:1,i:2,u:3,s:4,a:5},f={};for(var g in e)e.hasOwnProperty(g)&&(f[e[g]]=g);var h=function(a,b,c){var d=a.contents();d.each(function(a,d){var f=$(d);if(f.context&&3!==f.context.nodeType){var g=f.context.tagName.toLowerCase(),i=e[g];i&&b.push({type:i,start:c,end:c+f.text().length}),h(f,b,c)}c+=f.text().length})},i=function(a,b){if(b=b||[],!a)return a;for(var c={},d={},e=0;e<b.length;e++){var g=b[e];null!==g.start&&null!==g.end&&(c[g.start]=c[g.start]||[],c[g.start].push(g),d[g.end]=d[g.end]||[],d[g.end].push(g))}for(var h="",i=[],j=0;j<=a.length;j++){if(d[j])for(var k=d[j],l=d[j].length;l>0;){for(var m=0,n=i[i.length-1];m<k.length;){if(n===k[m].type){h+="</"+f[k[m].type]+">",i.pop();break}m++}m<k.length&&k.splice(m,1),l--}if(c[j])for(var o=c[j],p=0;p<o.length;p++){var q=o[p];"undefined"!=typeof f[q.type]&&(i.push(q.type),h+="<"+f[q.type]+">")}"undefined"!=typeof a[j]&&(h+=a[j])}if(0!==i.length)throw new Error("Inconsistent tags");return h},j=function(c){var d=c.prop("tagName").toLowerCase(),e=null;if(d&&"undefined"!=typeof b[d]){var f=[];h(c,f,0),e={markups:f,name:c.attr("name"),text:a.htmlEntities(c.text()),type:b[d]}}return e};this.generateModel=function(a){var b={paragraphs:[]},c=b.paragraphs;return a.find(".se-elem").each(function(){var a=j($(this));a&&c.push(a)}),b},this.generateHTMLFromModel=function(a){if(!a||!a.paragraphs)return null;for(var b=[],d=0;d<a.paragraphs.length;d++){var e=a.paragraphs[d],f=c[e.type];f&&(b.push("<"+f+" name='"+e.name+"' class='se-elem se-elem--"+f+"'>"),b.push(i(e.text,e.markups)),b.push("</"+f+">"))}return b.join("")};var k={CREATE:1,DELETE:2,UPDATE:3},l={};for(var m in k)k.hasOwnProperty(m)&&(l[k[m]]=m);this.computeDelta=function(b,c){var d=[];if(b!=c){var e=b.paragraphs,f=c.paragraphs,g=e.reduce(function(a,b,c){return a[b.name]={value:b,index:c},a},{}),h=f.reduce(function(a,b,c){return a[b.name]={value:b,index:c},a},{});for(var i in g){var j=g[i].value,l=g[i].index;h[i]?angular.equals(j,h[i].value)||d.push({index:h[i].index,paragraph:h[i].value,type:k.UPDATE}):d.push({index:l,type:k.DELETE})}for(var m in h){var n=h[m].value,o=h[m].index;g[m]||d.push({index:o,paragraph:n,type:k.CREATE})}}return{rev:a.generateRandomName(),dt:Date.now(),deltas:d}},this.applyDelta=function(a,b){if(!a||!a.paragraphs)throw new Error("Invalid source object");if(!(b&&b.deltas&&b.dt))throw new Error("Invalid delta object");if(!b.deltas.length)return a;for(var c=0;c<b.deltas.length;c++){var d=b.deltas[c],e=d.paragraph,f=a.paragraphs,g=d.index,h=d.type;if(h!==k.CREATE&&"undefined"==typeof f[g]||h===k.CREATE&&typeof f.length<g-1)throw new Error("Delta is not valid for this source");h===k.DELETE?f.splice(g,1):h===k.CREATE?f.splice(g,0,e):h===k.UPDATE&&(f[g]=e)}return a}});var smalleditor=angular.module("smalleditor");smalleditor.service("SmalleditorService",function(){this.isFirefox=navigator.userAgent.match(/firefox/i),this.isChrome=navigator.userAgent.match(/chrome/i),this.setCaret=function(a){if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();if(!b)return;b.selectNodeContents(a),b.collapse(!1),this.isFirefox&&b.setEndBefore($(a).find("br").get(0));var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}},this.getSelectionStart=function(){var a=document.getSelection().anchorNode,b=a&&3===a.nodeType?a.parentNode:a;return b},this.rangeSelectsSingleNode=function(a){var b=a.startContainer;return b===a.endContainer&&b.hasChildNodes()&&a.endOffset===a.startOffset+1},this.getSelectedParentElement=function(){var a=null,b=window.getSelection(),c=b.getRangeAt(0);return a=this.rangeSelectsSingleNode(c)?c.startContainer.childNodes[c.startOffset]:3===c.startContainer.nodeType?c.startContainer.parentNode:c.startContainer}}),smalleditor.directive("smalleditor",["$timeout","SmalleditorCore","SmalleditorService",function(a,b,c){"use strict";return{scope:{api:"=?api"},templateUrl:"views/_se_toolbar.html",link:function(d,e,f){var g=d.api={};d.position={top:10,left:10,below:!1},d.buttons={},(f.buttons||"b,i").split(",").reduce(function(a,b){var c=b.trim().toLowerCase();return c&&(a[c]=!0),a},d.buttons),d.enableToolbar="false"!=f.enabletoolbar,d.showToolbar="true"==f.showtoolbar,d.showPlaceholder=!1,d.placeholder=f.placeholder||"Type your text",d.allowPaste="false"!=f.paste,d.plainPaste="false"!=f.plain_paste,d.htmlPaste="true"==f.html_paste;var h="p h1 h2 h3 h4 h5 h6 pre blockquote".split(" "),i=h.join(","),j="span em strong mark".split(" "),k=j.join(","),l=e.find(".smalleditor-toolbar"),m=e.find(".smalleditor-content"),n=angular.element(document.getElementsByTagName("body"));m.attr("contenteditable",!0);var o=function(){return b.generateRandomName()},p=function(){var a=l[0].offsetHeight,b=l[0].offsetWidth,c=5,e=window.getSelection(),f=e.getRangeAt(0),g=f.getBoundingClientRect(),h=g.top,i=g.left;g.top<a+c?(d.position.top=h+g.height+c,d.position.below=!0):(d.position.top=h-a-c,d.position.below=!1),d.position.left=i-b/2+g.width/2;var j=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,k=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;return d.position.top+=k,d.position.left+=j,this},q=function(b){if(b&&b.target&&l.find(b.target).length)return!1;var c=window.getSelection(),e=c.anchorNode;if(!e)return d.showToolbar=!1,this;for(var f=e.parentNode;void 0!==f.tagName&&f!==m.get(0);)f=f.parentNode;return f===m.get(0)?(a(function(){""!==c.toString().trim()&&e?(d.showToolbar=!0,p()):d.showToolbar=!1}),s()):a(function(){d.showToolbar=!1}),this},r=function(){m.bind("keyup",q),document.addEventListener("mouseup",q);var a;m.bind("blur",function(){a&&clearTimeout(a),a=setTimeout(q,200)})},s=function(){var a=c.getSelectedParentElement();for(d.styles={};a&&void 0!==a.tagName&&m.get(0)!=a;)d.styles[a.tagName.toLowerCase()]=!0,a=a.parentNode},t=function(){var a=function(){""===m.get(0).textContent.replace(/^\s+|\s+$/g,"")&&(d.showPlaceholder=!0)},b=function(b){d.showPlaceholder=!1,"keypress"!==b.type&&"paste"!==b.type&&a()};a(),m.on("blur.placeholder",a).on("keypress.placeholder paste.placeholder",b)},u=function(){m.on("paste.se_paste",function(a){if(a.preventDefault(),!d.allowPaste)return!1;var c=a.originalEvent||a;if(c.clipboardData)if(c.clipboardData.getData("text/plain")&&d.plainPaste){for(var e=c.clipboardData.getData("text/plain").split(/[\r\n]/g),f="",g=0;g<e.length;g+=1)if(""!==e[g].trim()){var h=b.htmlEntities(e[g].trim());h&&(f+=0===g?h:'<p name="'+o()+'" class="se-elem se-elem--p">'+h+"</p>")}f&&document.execCommand("insertHTML",!1,f)}else c.clipboardData.getData("text/html")&&d.htmlPaste})},v=function(){m.find("> .se-elem").find(i).contents().unwrap()},w=function(){m.on("keyup.internal_noise, paste.internal_noise, focus.internal_noise",function(){a(function(){m.find("> br[type=_moz], > br").remove(),m.find(k).contents().unwrap(),m.find("[style]").removeAttr("style"),v()})})},x=function(){m.find(".se-elem--first").removeClass("se-elem--first"),m.find(".se-elem").first().addClass("se-elem--first")},y=function(){var a=$("<p>",{name:o(),"class":"se-elem se-elem--p"}).appendTo(m);return a.append("<br/>"),c.setCaret(a.get(0)),x(),a},z=function(){m.on("blur keyup paste focus",function(){var a=m.find(".se-elem");0===a.size()&&y(),m.contents().each(function(){return function(a,b){return"#text"===b.nodeName?(document.execCommand("insertHTML",!1,"<p name="+o()+" class='se-elem se-elem--p'>"+b.data+"<br/></p>"),x(),b.remove()):void 0}}(this))})},A=function(){m.on("keyup.paragraph_creation",function(a){if(13===a.which&&!a.shiftKey){document.execCommand("formatBlock",!1,"p");var b=c.getSelectionStart(),d=$(b).closest(".se-elem");0===d.size()&&(d=$(b)),d.attr("name",o()).addClass("se-elem se-elem--p"),x()}})},B=function(){t(),r(),u(),A(),w(),z()};d.SimpleAction=function(a,b){if(b=b&&b.toLowerCase(),document.execCommand("styleWithCSS",!1,!1),document.execCommand(a,!1,b),"formatBlock"==a){var d=c.getSelectionStart(),e=$(d).closest(b);0===e.size()&&(e=$(d).prev(b)),e.attr("name",o()).addClass("se-elem se-elem--"+b),v(),x()}},n.append(l),B(),g.dataModel=function(a){return a?void m.html(b.generateHTMLFromModel(a)):b.generateModel(m)},g.getHTML=function(a){return a?b.generateHTMLFromModel(a):null},g.computeDelta=b.computeDelta,g.applyDelta=b.applyDelta}}}]),angular.module("smalleditor").run(["$templateCache",function(a){"use strict";a.put("views/_se_toolbar.html",'<div class="smalleditor">\n  <div class="smalleditor-toolbar" style="top: {{ position.top }}px; left: {{ position.left }}px" ng-class="{ \'smalleditor-toolbar--show\': showToolbar, \'smalleditor-toolbar--bottom\': position.below }">\n    <div class="se-toolbar-inner">\n      <ul class="se-main-toolbar">\n        <li class="se-li" ng-show="buttons.b">\n          <button type="button" ng-click="SimpleAction(\'bold\')" class="se-button se-button--bold" ng-class="{ \'se-button--active\': styles.b }">\n            <b>B</b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.i">\n          <button type="button" ng-click="SimpleAction(\'italic\')" class="se-button se-button--italic" ng-class="{ \'se-button--active\': styles.i }">\n            <i>I</i>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.u">\n          <button type="button" ng-click="SimpleAction(\'underline\')" class="se-button se-button--underline" ng-class="{ \'se-button--active\': styles.u }">\n            <b><u>U</u></b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.h1">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.h1 ? \'p\' : \'h1\')" class="se-button se-button--h1" ng-class="{ \'se-button--active\': styles.h1 }">\n            <b>H1</b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.h2">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.h2 ? \'p\' : \'h2\')" class="se-button se-button--h2" ng-class="{ \'se-button--active\': styles.h2 }">\n            <b>H2</b>\n          </button>\n        </li>\n        <li class="se-li" ng-show="buttons.blockquote">\n          <button type="button" ng-click="SimpleAction(\'formatBlock\', styles.blockquote ? \'p\' : \'blockquote\')" class="se-button se-button--blockquote" ng-class="{ \'se-button--active\': styles.blockquote }">\n            <b>"</b>\n          </button>\n        </li>\n      </ul>\n    </div>\n    <div class="se-down-arrow-clip">\n      <span class="se-down-arrow"></span>\n    </div>\n  </div>\n  <div class="smalleditor-content" ng-class="{\'smalleditor-placeholder\': showPlaceholder}" data-placeholder="{{ placeholder }}">\n  </div>\n</div>\n')}]);